"0","library(readr)"
"0","library(dplyr)"
"0","library(here)"
"0",""
"0","# --- 读文件（自动识别逗号/分号分隔）---"
"0","read_any <- function(path){"
"0","  x <- suppressMessages(tryCatch(readr::read_csv(path, show_col_types = FALSE), error=function(e) NULL))"
"0","  if (!is.null(x) && ncol(x) > 1) return(x)"
"0","  x <- suppressMessages(tryCatch(readr::read_csv2(path, show_col_types = FALSE), error=function(e) NULL)) # ; 分隔"
"0","  if (!is.null(x) && ncol(x) > 1) return(x)"
"0","  x <- suppressMessages(tryCatch(readr::read_delim(path, delim="";"", show_col_types = FALSE), error=function(e) NULL))"
"0","  if (!is.null(x) && ncol(x) > 1) return(x)"
"0","  stop(""无法读取："", path)"
"0","}"
"0",""
"0","# --- 列名容错匹配 ---"
"0","norm <- function(s) gsub(""[^a-z0-9]"", """", tolower(s))"
"0","match_col <- function(df, candidates){"
"0","  nms <- names(df); key <- norm(nms); cand <- norm(candidates)"
"0","  hit <- match(cand, key, nomatch = 0); if (any(hit>0)) return(nms[hit[hit>0][1]])"
"0","  for (c in cand){ w <- which(grepl(c, key, fixed = TRUE)); if (length(w)) return(nms[w[1]]) }"
"0","  NA_character_"
"0","}"
"0",""
"0","pick_cols <- function(df){"
"0","  list("
"0","    date  = match_col(df, c(""date"",""day"")),"
"0","    clicks= match_col(df, c(""# of website clicks"",""website clicks"",""link clicks"",""clicks"",""# of clicks"")),"
"0","    purch = match_col(df, c(""# of purchase"",""# of purchases"",""purchases"",""purchase"",""conversions""))"
"0","  )"
"0","}"
"0",""
"0","# --- 读取两组 ---"
"0","control_raw <- read_any(here(""data"",""control_group.csv""))"
"0","test_raw    <- read_any(here(""data"",""test_group.csv""))"
"0",""
"0","cmap <- pick_cols(control_raw)"
"0","tmap <- pick_cols(test_raw)"
"0",""
"0","# --- 安全除法 ---"
"0","safe_div <- function(a,b) ifelse(is.na(b) | b==0, NA_real_, a/b)"
"0",""
"0","# --- 生成 Daily CR 表：Date, Purchases, Clicks, CR, Group ---"
"0","make_daily_cr <- function(df, m, group_name){"
"0","  df %>%"
"0","    transmute("
"0","      Date      = .data[[m$date]],"
"0","      Purchases = suppressWarnings(as.numeric(.data[[m$purch]])),"
"0","      Clicks    = suppressWarnings(as.numeric(.data[[m$clicks]])),"
"0","      CR        = safe_div(Purchases, Clicks),"
"0","      Group     = group_name"
"0","    )"
"0","}"
"0",""
"0","control_daily_cr <- make_daily_cr(control_raw, cmap, ""Control"") %>%"
"0","  filter(!is.na(CR), is.finite(CR))"
"0",""
"0","test_daily_cr <- make_daily_cr(test_raw, tmap, ""Test"") %>%"
"0","  filter(!is.na(CR), is.finite(CR))"
"0",""
"0","# 合并（如需整体查看）"
"0","daily_cr_all <- bind_rows(control_daily_cr, test_daily_cr)"
"0",""
"0","# 保存各表（可选）"
"0","write_csv(control_daily_cr, here(""data"",""control_daily_cr.csv""))"
"0","write_csv(test_daily_cr,    here(""data"",""test_daily_cr.csv""))"
"0","write_csv(daily_cr_all,     here(""data"",""cr_by_day.csv""))"
"0",""
"0","# 打印前5行示例（和你截图风格一致）"
"0","print(dplyr::slice_head(control_daily_cr, n = 5))"
